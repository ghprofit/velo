// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum UserRole {
  CREATOR
  ADMIN
  SUPPORT
  SUPER_ADMIN
}

enum VerificationStatus {
  PENDING
  IN_PROGRESS
  VERIFIED
  REJECTED
  EXPIRED
}

enum ContentStatus {
  PENDING_REVIEW
  APPROVED
  REJECTED
  FLAGGED
  REMOVED
}

enum ComplianceCheckStatus {
  PENDING
  PASSED
  FAILED
  MANUAL_REVIEW
}

// User Models
model User {
  id                String              @id @default(cuid())
  email             String              @unique
  password          String
  role              UserRole            @default(CREATOR)
  isActive          Boolean             @default(true)
  emailVerified     Boolean             @default(false)
  lastLogin         DateTime?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  // 2FA Fields
  twoFactorEnabled    Boolean   @default(false)
  twoFactorSecret     String?
  backupCodes         String[]  @default([])
  twoFactorVerifiedAt DateTime?

  // Security Fields
  failedLoginAttempts Int       @default(0)
  lockedUntil         DateTime?

  // Profile Fields
  displayName       String?
  firstName         String?
  lastName          String?
  profilePicture    String?

  // Notification Preferences
  notifyPayoutUpdates      Boolean @default(true)
  notifyContentEngagement  Boolean @default(true)
  notifyPlatformAnnouncements Boolean @default(true)
  notifyMarketingEmails    Boolean @default(false)

  // Relations
  creatorProfile    CreatorProfile?
  refreshTokens     RefreshToken[]
  adminActions      AdminAction[]
  supportTickets    SupportTicket[]
  notifications     Notification[]
  emailVerificationToken EmailVerificationToken?
  passwordResetTokens PasswordResetToken[]

  @@index([email])
  @@map("users")
}

// Email Verification
model EmailVerificationToken {
  id        String   @id @default(cuid())
  userId    String   @unique
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  // Relations
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@map("email_verification_tokens")
}

// Password Reset
model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  // Relations
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@map("password_reset_tokens")
}

model CreatorProfile {
  id                    String              @id @default(cuid())
  userId                String              @unique
  displayName           String
  bio                   String?
  profileImage          String?
  coverImage            String?

  // Verification
  verificationStatus    VerificationStatus  @default(PENDING)
  veriffSessionId       String?             @unique
  veriffDecisionId      String?
  verifiedAt            DateTime?
  verificationNotes     String?

  // KYC Info
  firstName             String?
  lastName              String?
  dateOfBirth           DateTime?
  country               String?

  // Payout Info - Bank Account
  bankAccountName       String?
  bankName              String?
  bankAccountNumber     String?
  bankRoutingNumber     String?             // For US banks (ABA routing number)
  bankSwiftCode         String?             // For international transfers
  bankIban              String?             // For European banks
  bankCountry           String?
  bankCurrency          String?             @default("USD")
  payoutSetupCompleted  Boolean             @default(false)

  // Stats
  totalEarnings         Float               @default(0)
  totalViews            Int                 @default(0)
  totalPurchases        Int                 @default(0)

  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  // Relations
  user                  User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  content               Content[]
  payouts               Payout[]

  @@index([userId])
  @@index([verificationStatus])
  @@map("creator_profiles")
}

// Content Models
model Content {
  id                    String              @id @default(cuid())
  creatorId             String
  title                 String
  description           String?
  price                 Float
  thumbnailUrl          String
  contentType           String              // VIDEO, IMAGE, GALLERY

  // AWS Storage
  s3Key                 String              @unique
  s3Bucket              String
  fileSize              Int                 // in bytes
  duration              Int?                // for videos in seconds

  // Status
  status                ContentStatus       @default(PENDING_REVIEW)
  isPublished           Boolean             @default(false)
  publishedAt           DateTime?

  // Compliance
  complianceStatus      ComplianceCheckStatus @default(PENDING)
  complianceCheckedAt   DateTime?
  complianceNotes       String?

  // Stats
  viewCount             Int                 @default(0)
  purchaseCount         Int                 @default(0)
  totalRevenue          Float               @default(0)

  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  // Relations
  creator               CreatorProfile      @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  complianceLogs        ComplianceLog[]
  purchases             Purchase[]
  contentItems          ContentItem[]       // For galleries with multiple items
  contentViews          ContentView[]       // View tracking with demographics

  @@index([creatorId])
  @@index([status])
  @@index([complianceStatus])
  @@index([isPublished])
  @@map("content")
}

model ContentItem {
  id                    String              @id @default(cuid())
  contentId             String
  s3Key                 String              @unique
  s3Bucket              String
  fileSize              Int
  order                 Int                 @default(0)
  createdAt             DateTime            @default(now())

  // Relations
  content               Content             @relation(fields: [contentId], references: [id], onDelete: Cascade)

  @@index([contentId])
  @@map("content_items")
}

model ComplianceLog {
  id                    String              @id @default(cuid())
  contentId             String
  checkType             String              // AWS_REKOGNITION, MANUAL_REVIEW
  status                ComplianceCheckStatus
  confidence            Float?
  flaggedReasons        String[]            @default([])
  moderationLabels      Json?               // AWS Rekognition labels
  reviewedBy            String?             // Admin user ID
  notes                 String?
  createdAt             DateTime            @default(now())

  // Relations
  content               Content             @relation(fields: [contentId], references: [id], onDelete: Cascade)

  @@index([contentId])
  @@index([status])
  @@map("compliance_logs")
}

// Anonymous Buyer Tracking
model BuyerSession {
  id                    String              @id @default(cuid())
  sessionToken          String              @unique
  fingerprint           String?             // Browser fingerprint
  ipAddress             String?
  userAgent             String?
  lastActive            DateTime            @default(now())
  expiresAt             DateTime
  createdAt             DateTime            @default(now())

  // Relations
  purchases             Purchase[]

  @@index([sessionToken])
  @@index([fingerprint])
  @@map("buyer_sessions")
}

model Purchase {
  id                    String              @id @default(cuid())
  contentId             String
  buyerSessionId        String

  // Payment Info
  amount                Float
  currency              String              @default("USD")
  paymentProvider       String              // STRIPE, PAYPAL
  paymentIntentId       String?             @unique
  transactionId         String?             @unique

  // Status
  status                String              @default("PENDING") // PENDING, COMPLETED, FAILED, REFUNDED

  // Access
  accessToken           String              @unique // Unique token for viewing purchased content
  accessExpiresAt       DateTime?           // Optional expiration
  viewCount             Int                 @default(0)
  lastViewedAt          DateTime?

  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  // Relations
  content               Content             @relation(fields: [contentId], references: [id])
  buyerSession          BuyerSession        @relation(fields: [buyerSessionId], references: [id])

  @@index([contentId])
  @@index([buyerSessionId])
  @@index([accessToken])
  @@map("purchases")
}

// Authentication
model RefreshToken {
  id                    String              @id @default(cuid())
  userId                String
  token                 String              @unique
  expiresAt             DateTime
  createdAt             DateTime            @default(now())

  // Session Metadata
  deviceName            String?
  ipAddress             String?
  userAgent             String?
  lastUsedAt            DateTime            @default(now())

  // Relations
  user                  User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

// Payouts
model Payout {
  id                    String              @id @default(cuid())
  creatorId             String
  amount                Float
  currency              String              @default("USD")
  status                String              @default("PENDING") // PENDING, PROCESSING, COMPLETED, FAILED
  paymentMethod         String              // PAYPAL, STRIPE
  paymentId             String?
  processedAt           DateTime?
  notes                 String?
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  // Relations
  creator               CreatorProfile      @relation(fields: [creatorId], references: [id])

  @@index([creatorId])
  @@index([status])
  @@map("payouts")
}

// Admin Actions Log
model AdminAction {
  id                    String              @id @default(cuid())
  adminId               String
  action                String              // APPROVE_CONTENT, REJECT_CONTENT, SUSPEND_USER, etc.
  targetType            String              // USER, CONTENT, PURCHASE
  targetId              String
  reason                String?
  metadata              Json?
  createdAt             DateTime            @default(now())

  // Relations
  admin                 User                @relation(fields: [adminId], references: [id])

  @@index([adminId])
  @@index([targetType, targetId])
  @@map("admin_actions")
}

// Support System
model SupportTicket {
  id                    String              @id @default(cuid())
  userId                String?             // Optional for authenticated users
  email                 String
  subject               String
  message               String
  status                String              @default("OPEN") // OPEN, IN_PROGRESS, RESOLVED, CLOSED
  priority              String              @default("MEDIUM") // LOW, MEDIUM, HIGH, URGENT
  assignedTo            String?
  resolvedAt            DateTime?
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  // Relations
  user                  User?               @relation(fields: [userId], references: [id])
  attachments           SupportAttachment[]

  @@index([userId])
  @@index([status])
  @@map("support_tickets")
}

// Support Ticket Attachments
model SupportAttachment {
  id                    String              @id @default(cuid())
  ticketId              String

  // AWS S3 Storage
  s3Key                 String              @unique
  s3Bucket              String

  // File Metadata
  fileName              String
  fileSize              Int
  contentType           String

  // Tracking
  order                 Int                 @default(0)
  createdAt             DateTime            @default(now())

  // Relations
  ticket                SupportTicket       @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId])
  @@map("support_attachments")
}

// Notifications
model Notification {
  id                    String              @id @default(cuid())
  userId                String
  type                  String              // VERIFICATION_APPROVED, CONTENT_APPROVED, PAYOUT_SENT, etc.
  title                 String
  message               String
  isRead                Boolean             @default(false)
  metadata              Json?
  createdAt             DateTime            @default(now())

  // Relations
  user                  User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@map("notifications")
}

// Content Views - Track view events with geographic data
model ContentView {
  id                    String              @id @default(cuid())
  contentId             String

  // Geographic Data (from IP lookup)
  country               String?
  countryCode           String?
  region                String?
  city                  String?

  // Device Info
  deviceType            String?             // desktop, mobile, tablet
  browser               String?
  os                    String?

  // Session Info
  ipAddress             String?
  userAgent             String?
  referrer              String?

  createdAt             DateTime            @default(now())

  // Relations
  content               Content             @relation(fields: [contentId], references: [id], onDelete: Cascade)

  @@index([contentId])
  @@index([country])
  @@index([createdAt])
  @@map("content_views")
}