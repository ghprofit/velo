// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// Enums
enum UserRole {
  CREATOR
  ADMIN
  SUPPORT
  SUPER_ADMIN
}

enum VerificationStatus {
  PENDING
  IN_PROGRESS
  VERIFIED
  REJECTED
  EXPIRED
}

enum ContentStatus {
  PENDING_REVIEW
  APPROVED
  REJECTED
  FLAGGED
  REMOVED
}

enum ComplianceCheckStatus {
  PENDING
  PASSED
  FAILED
  MANUAL_REVIEW
}

enum AdminRole {
  FINANCIAL_ADMIN
  CONTENT_ADMIN
  SUPPORT_SPECIALIST
  ANALYTICS_ADMIN
}

enum AdminStatus {
  ACTIVE
  SUSPENDED
  INVITED
}

enum PayoutStatus {
  ACTIVE
  ON_HOLD
  SUSPENDED
}

// User Models
model User {
  id                String              @id @default(cuid())
  email             String              @unique
  password          String
  role              UserRole            @default(CREATOR)
  isActive          Boolean             @default(true)
  emailVerified     Boolean             @default(false)
  lastLogin         DateTime?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  // Relations
  creatorProfile    CreatorProfile?
  adminProfile      AdminProfile?
  refreshTokens     RefreshToken[]
  adminActions      AdminAction[]
  supportTickets    SupportTicket[]
  notifications     Notification[]
  emailVerificationToken EmailVerificationToken?

  @@index([email])
  @@map("users")
}

// Admin Profile for staff members
model AdminProfile {
  id                    String              @id @default(cuid())
  userId                String              @unique
  fullName              String
  adminRole             AdminRole
  status                AdminStatus         @default(INVITED)

  // Permissions
  permDashboard         Boolean             @default(true)
  permCreatorManagement Boolean             @default(false)
  permContentReview     Boolean             @default(false)
  permFinancialReports  Boolean             @default(false)
  permSystemSettings    Boolean             @default(false)
  permSupportTickets    Boolean             @default(false)

  // Security
  twoFactorEnabled      Boolean             @default(false)
  lastPasswordReset     DateTime?
  mustChangePassword    Boolean             @default(true)

  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  // Relations
  user                  User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([adminRole])
  @@index([status])
  @@map("admin_profiles")
}

// Email Verification
model EmailVerificationToken {
  id        String   @id @default(cuid())
  userId    String   @unique
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  // Relations
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@map("email_verification_tokens")
}

model CreatorProfile {
  id                    String              @id @default(cuid())
  userId                String              @unique
  displayName           String
  bio                   String?
  profileImage          String?
  coverImage            String?

  // Verification
  verificationStatus    VerificationStatus  @default(PENDING)
  veriffSessionId       String?             @unique
  veriffDecisionId      String?
  verifiedAt            DateTime?
  verificationNotes     String?

  // KYC Info
  firstName             String?
  lastName              String?
  dateOfBirth           DateTime?
  country               String?

  // Payout Info
  paypalEmail           String?
  stripeAccountId       String?
  payoutStatus          PayoutStatus        @default(ACTIVE)

  // Policy
  policyStrikes         Int                 @default(0)

  // Stats
  totalEarnings         Float               @default(0)
  totalViews            Int                 @default(0)
  totalPurchases        Int                 @default(0)

  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  // Relations
  user                  User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  content               Content[]
  payouts               Payout[]

  @@index([userId])
  @@index([verificationStatus])
  @@index([payoutStatus])
  @@map("creator_profiles")
}

// Content Models
model Content {
  id                    String              @id @default(cuid())
  creatorId             String
  title                 String
  description           String?
  price                 Float
  thumbnailUrl          String
  contentType           String              // VIDEO, IMAGE, GALLERY

  // AWS Storage
  s3Key                 String              @unique
  s3Bucket              String
  fileSize              Int                 // in bytes
  duration              Int?                // for videos in seconds

  // Status
  status                ContentStatus       @default(PENDING_REVIEW)
  isPublished           Boolean             @default(false)
  publishedAt           DateTime?

  // Compliance
  complianceStatus      ComplianceCheckStatus @default(PENDING)
  complianceCheckedAt   DateTime?
  complianceNotes       String?

  // Stats
  viewCount             Int                 @default(0)
  purchaseCount         Int                 @default(0)
  totalRevenue          Float               @default(0)

  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  // Relations
  creator               CreatorProfile      @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  complianceLogs        ComplianceLog[]
  purchases             Purchase[]
  contentItems          ContentItem[]       // For galleries with multiple items

  @@index([creatorId])
  @@index([status])
  @@index([complianceStatus])
  @@index([isPublished])
  @@map("content")
}

model ContentItem {
  id                    String              @id @default(cuid())
  contentId             String
  s3Key                 String              @unique
  s3Bucket              String
  fileSize              Int
  order                 Int                 @default(0)
  createdAt             DateTime            @default(now())

  // Relations
  content               Content             @relation(fields: [contentId], references: [id], onDelete: Cascade)

  @@index([contentId])
  @@map("content_items")
}

model ComplianceLog {
  id                    String              @id @default(cuid())
  contentId             String
  checkType             String              // AWS_REKOGNITION, MANUAL_REVIEW
  status                ComplianceCheckStatus
  confidence            Float?
  flaggedReasons        String[]            @default([])
  moderationLabels      Json?               // AWS Rekognition labels
  reviewedBy            String?             // Admin user ID
  notes                 String?
  createdAt             DateTime            @default(now())

  // Relations
  content               Content             @relation(fields: [contentId], references: [id], onDelete: Cascade)

  @@index([contentId])
  @@index([status])
  @@map("compliance_logs")
}

// Anonymous Buyer Tracking
model BuyerSession {
  id                    String              @id @default(cuid())
  sessionToken          String              @unique
  fingerprint           String?             // Browser fingerprint
  ipAddress             String?
  userAgent             String?
  lastActive            DateTime            @default(now())
  expiresAt             DateTime
  createdAt             DateTime            @default(now())

  // Relations
  purchases             Purchase[]

  @@index([sessionToken])
  @@index([fingerprint])
  @@map("buyer_sessions")
}

model Purchase {
  id                    String              @id @default(cuid())
  contentId             String
  buyerSessionId        String

  // Payment Info
  amount                Float
  currency              String              @default("USD")
  paymentProvider       String              // STRIPE, PAYPAL
  paymentIntentId       String?             @unique
  transactionId         String?             @unique

  // Status
  status                String              @default("PENDING") // PENDING, COMPLETED, FAILED, REFUNDED

  // Access
  accessToken           String              @unique // Unique token for viewing purchased content
  accessExpiresAt       DateTime?           // Optional expiration
  viewCount             Int                 @default(0)
  lastViewedAt          DateTime?

  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  // Relations
  content               Content             @relation(fields: [contentId], references: [id])
  buyerSession          BuyerSession        @relation(fields: [buyerSessionId], references: [id])

  @@index([contentId])
  @@index([buyerSessionId])
  @@index([accessToken])
  @@map("purchases")
}

// Authentication
model RefreshToken {
  id                    String              @id @default(cuid())
  userId                String
  token                 String              @unique
  expiresAt             DateTime
  createdAt             DateTime            @default(now())

  // Relations
  user                  User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

// Payouts
model Payout {
  id                    String              @id @default(cuid())
  creatorId             String
  amount                Float
  currency              String              @default("USD")
  status                String              @default("PENDING") // PENDING, PROCESSING, COMPLETED, FAILED
  paymentMethod         String              // PAYPAL, STRIPE
  paymentId             String?
  processedAt           DateTime?
  notes                 String?
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  // Relations
  creator               CreatorProfile      @relation(fields: [creatorId], references: [id])

  @@index([creatorId])
  @@index([status])
  @@map("payouts")
}

// Admin Actions Log
model AdminAction {
  id                    String              @id @default(cuid())
  adminId               String
  action                String              // APPROVE_CONTENT, REJECT_CONTENT, SUSPEND_USER, etc.
  targetType            String              // USER, CONTENT, PURCHASE
  targetId              String
  reason                String?
  metadata              Json?
  createdAt             DateTime            @default(now())

  // Relations
  admin                 User                @relation(fields: [adminId], references: [id])

  @@index([adminId])
  @@index([targetType, targetId])
  @@map("admin_actions")
}

// Support System
model SupportTicket {
  id                    String              @id @default(cuid())
  userId                String?             // Optional for authenticated users
  email                 String
  subject               String
  message               String
  status                String              @default("OPEN") // OPEN, IN_PROGRESS, RESOLVED, CLOSED
  priority              String              @default("MEDIUM") // LOW, MEDIUM, HIGH, URGENT
  assignedTo            String?
  resolvedAt            DateTime?
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  // Relations
  user                  User?               @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([status])
  @@map("support_tickets")
}

// Notifications
model Notification {
  id                    String              @id @default(cuid())
  userId                String
  type                  String              // VERIFICATION_APPROVED, CONTENT_APPROVED, PAYOUT_SENT, etc.
  title                 String
  message               String
  isRead                Boolean             @default(false)
  metadata              Json?
  createdAt             DateTime            @default(now())

  // Relations
  user                  User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@map("notifications")
}
// Platform Settings
model PlatformSettings {
  id                    String              @id @default(cuid())
  key                   String              @unique
  value                 String
  description           String?
  category              String              @default("general") // general, payments, content, security
  isPublic              Boolean             @default(false)
  updatedBy             String?
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  @@index([category])
  @@index([key])
  @@map("platform_settings")
}
